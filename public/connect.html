<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HANI-MD - Connexion WhatsApp Client</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    }
    
    .logo {
      font-size: 3em;
      margin-bottom: 10px;
    }
    
    h1 {
      color: #333;
      margin-bottom: 5px;
      font-size: 1.8em;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 25px;
      font-size: 0.95em;
    }
    
    .plan-badge {
      display: inline-block;
      padding: 8px 20px;
      border-radius: 25px;
      font-weight: bold;
      font-size: 1em;
      margin-bottom: 20px;
    }
    
    .plan-bronze { background: linear-gradient(135deg, #CD7F32, #8B4513); color: white; }
    .plan-argent { background: linear-gradient(135deg, #C0C0C0, #808080); color: #333; }
    .plan-or { background: linear-gradient(135deg, #FFD700, #FFA500); color: #333; }
    .plan-diamant { background: linear-gradient(135deg, #00CED1, #5F9EA0); color: white; }
    .plan-lifetime { background: linear-gradient(135deg, #8B008B, #4B0082); color: white; }
    
    #qr-container {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 15px;
      margin: 20px 0;
      min-height: 280px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #qr-container img {
      max-width: 250px;
      border-radius: 10px;
    }
    
    .status {
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      font-weight: 500;
    }
    
    .status-waiting {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffc107;
    }
    
    .status-connected {
      background: #d4edda;
      color: #155724;
      border: 1px solid #28a745;
    }
    
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #dc3545;
    }
    
    .status-loading {
      background: #cce5ff;
      color: #004085;
      border: 1px solid #007bff;
    }
    
    .instructions {
      background: #e8f4fd;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }
    
    .instructions h3 {
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .instructions ol {
      padding-left: 20px;
    }
    
    .instructions li {
      margin: 10px 0;
      color: #555;
    }
    
    .features {
      background: #f0f0f0;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }
    
    .features h3 {
      color: #333;
      margin-bottom: 15px;
    }
    
    .feature-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .feature {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9em;
    }
    
    .feature.available { color: #28a745; }
    .feature.unavailable { color: #dc3545; text-decoration: line-through; opacity: 0.7; }
    
    .btn {
      display: inline-block;
      padding: 12px 30px;
      border-radius: 25px;
      font-weight: bold;
      text-decoration: none;
      margin: 10px 5px;
      cursor: pointer;
      border: none;
      font-size: 1em;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }
    
    .btn:hover { opacity: 0.9; transform: translateY(-2px); }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .expire-info {
      font-size: 0.85em;
      color: #666;
      margin-top: 10px;
    }
    
    .hidden { display: none !important; }
    
    @media (max-width: 480px) {
      .feature-list { grid-template-columns: 1fr; }
      h1 { font-size: 1.5em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">ü§ñ</div>
    <h1>HANI-MD Premium</h1>
    <p class="subtitle">Connectez votre WhatsApp personnel</p>
    
    <div id="plan-info">
      <span id="plan-badge" class="plan-badge plan-or">üíé Chargement...</span>
      <p id="expire-info" class="expire-info"></p>
    </div>
    
    <div id="status" class="status status-loading">
      üîÑ V√©rification de votre abonnement...
    </div>
    
    <div id="qr-container">
      <div class="spinner"></div>
    </div>
    
    <div class="instructions">
      <h3>üì± Comment connecter votre bot</h3>
      <ol>
        <li>Ouvrez <strong>WhatsApp</strong> sur votre t√©l√©phone</li>
        <li>Allez dans <strong>Param√®tres ‚Üí Appareils li√©s</strong></li>
        <li>Appuyez sur <strong>"Lier un appareil"</strong></li>
        <li>Scannez le <strong>QR code</strong> ci-dessus</li>
        <li>Votre bot personnel sera actif ! üéâ</li>
      </ol>
    </div>
    
    <div id="features-section" class="features">
      <h3>üéÅ Fonctionnalit√©s de votre plan</h3>
      <div id="feature-list" class="feature-list"></div>
    </div>
    
    <div id="connected-section" class="hidden">
      <div class="status status-connected">
        ‚úÖ Bot connect√© avec succ√®s !
      </div>
      <p style="margin: 20px 0;">
        Votre bot HANI-MD est maintenant actif sur votre WhatsApp.<br>
        Envoyez <strong>.menu</strong> pour voir les commandes.
      </p>
      <button class="btn btn-secondary" onclick="location.reload()">üîÑ Reconnecter</button>
    </div>
    
    <div style="margin-top: 20px;">
      <a href="/" class="btn btn-secondary">üè† Accueil</a>
      <a href="https://wa.me/22550252467" class="btn btn-primary" target="_blank">üí¨ Support</a>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const clientId = urlParams.get('id');
    const code = urlParams.get('code');
    
    const planEmoji = {
      'BRONZE': 'ü•â',
      'ARGENT': 'ü•à',
      'OR': 'ü•á',
      'DIAMANT': 'üíé',
      'LIFETIME': 'üëë'
    };
    
    const planFeatures = {
      'BRONZE': {
        available: ['100 cmds/jour', 'T√©l√©chargements', 'Stickers', 'Conversion'],
        unavailable: ['IA compl√®te', 'Gestion groupe', 'Anti-spam']
      },
      'ARGENT': {
        available: ['300 cmds/jour', 'T√©l√©chargements HD', 'GPT & DALL-E', 'Gestion groupe', 'Anti-spam'],
        unavailable: ['Commandes illimit√©es', 'Multi-num√©ros']
      },
      'OR': {
        available: ['Cmds ILLIMIT√âES', 'Toutes fonctions', 'IA sans limite', 'Support VIP'],
        unavailable: ['Multi-num√©ros', 'API Access']
      },
      'DIAMANT': {
        available: ['TOUT ILLIMIT√â', 'Multi-num√©ros (3)', 'API Access', 'Bot d√©di√©', 'Support personnel'],
        unavailable: []
      },
      'LIFETIME': {
        available: ['ACC√àS √Ä VIE', 'TOUT ILLIMIT√â', 'Mises √† jour gratuites', 'Support VIP permanent', 'Badge üëë'],
        unavailable: []
      }
    };
    
    async function checkStatus() {
      const statusDiv = document.getElementById('status');
      const qrContainer = document.getElementById('qr-container');
      const planBadge = document.getElementById('plan-badge');
      const expireInfo = document.getElementById('expire-info');
      const featureList = document.getElementById('feature-list');
      
      if (!clientId && !code) {
        statusDiv.className = 'status status-error';
        statusDiv.innerHTML = '‚ùå Lien invalide. Veuillez utiliser le lien envoy√© par le bot.';
        qrContainer.innerHTML = '<p>‚ö†Ô∏è Param√®tres manquants</p>';
        return;
      }
      
      try {
        // R√©cup√©rer les infos client
        const endpoint = clientId ? `/api/client/${clientId}` : `/api/client/code/${code}`;
        const response = await fetch(endpoint);
        const data = await response.json();
        
        if (!data.success) {
          statusDiv.className = 'status status-error';
          statusDiv.innerHTML = '‚ùå ' + (data.error || 'Client non trouv√©');
          qrContainer.innerHTML = '<p>‚ùå Abonnement invalide ou expir√©</p>';
          return;
        }
        
        const client = data.client;
        const plan = (client.plan || 'OR').toUpperCase();
        
        // Afficher le plan
        planBadge.className = `plan-badge plan-${plan.toLowerCase()}`;
        planBadge.innerHTML = `${planEmoji[plan] || 'üíé'} Plan ${plan}`;
        
        // Date d'expiration
        if (client.expiresAt) {
          const expDate = new Date(client.expiresAt);
          expireInfo.textContent = `Expire le ${expDate.toLocaleDateString('fr-FR')}`;
        } else {
          expireInfo.textContent = '‚ôæÔ∏è Acc√®s √† vie';
        }
        
        // Afficher les fonctionnalit√©s
        const features = planFeatures[plan] || planFeatures['OR'];
        featureList.innerHTML = '';
        features.available.forEach(f => {
          featureList.innerHTML += `<div class="feature available">‚úÖ ${f}</div>`;
        });
        features.unavailable.forEach(f => {
          featureList.innerHTML += `<div class="feature unavailable">‚ùå ${f}</div>`;
        });
        
        // V√©rifier l'√©tat de connexion
        if (client.status === 'connected') {
          document.getElementById('connected-section').classList.remove('hidden');
          document.getElementById('qr-container').classList.add('hidden');
          statusDiv.className = 'status status-connected';
          statusDiv.innerHTML = '‚úÖ Votre bot est d√©j√† connect√© !';
          return;
        }
        
        // R√©cup√©rer le QR
        statusDiv.className = 'status status-waiting';
        statusDiv.innerHTML = 'üì± Scannez le QR code avec WhatsApp...';
        
        await refreshQR();
        
        // Actualiser toutes les 15 secondes
        setInterval(refreshQR, 15000);
        
      } catch (error) {
        console.error(error);
        statusDiv.className = 'status status-error';
        statusDiv.innerHTML = '‚ùå Erreur de connexion au serveur';
      }
    }
    
    async function refreshQR() {
      const qrContainer = document.getElementById('qr-container');
      const statusDiv = document.getElementById('status');
      
      try {
        const endpoint = clientId ? `/api/client/${clientId}/qr` : `/api/client/code/${code}/qr`;
        const response = await fetch(endpoint);
        const data = await response.json();
        
        if (data.connected) {
          document.getElementById('connected-section').classList.remove('hidden');
          qrContainer.classList.add('hidden');
          statusDiv.className = 'status status-connected';
          statusDiv.innerHTML = '‚úÖ Bot connect√© avec succ√®s !';
          return;
        }
        
        if (data.qr) {
          qrContainer.innerHTML = `<img src="${data.qr}" alt="QR Code">`;
          statusDiv.className = 'status status-waiting';
          statusDiv.innerHTML = 'üì± Scannez le QR code avec WhatsApp...';
        } else {
          qrContainer.innerHTML = '<div class="spinner"></div>';
          statusDiv.className = 'status status-loading';
          statusDiv.innerHTML = 'üîÑ G√©n√©ration du QR code...';
        }
        
      } catch (error) {
        console.error(error);
      }
    }
    
    // D√©marrer
    checkStatus();
  </script>
</body>
</html>
