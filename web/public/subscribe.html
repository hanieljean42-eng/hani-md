<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S'abonner avec Wave - HANI-MD Premium</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); min-height: 100vh; color: white; padding: 20px; }
    .container { max-width: 550px; margin: 0 auto; padding: 20px; }
    .back-link { display: inline-flex; align-items: center; gap: 8px; color: white; text-decoration: none; margin-bottom: 30px; opacity: 0.8; transition: opacity 0.3s; }
    .back-link:hover { opacity: 1; }
    .progress-steps { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; }
    .progress-steps::before { content: ''; position: absolute; top: 20px; left: 15%; right: 15%; height: 3px; background: rgba(255,255,255,0.2); z-index: 0; }
    .step { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 1; flex: 1; }
    .step-number { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-weight: 700; margin-bottom: 8px; transition: all 0.3s; }
    .step.active .step-number { background: linear-gradient(135deg, #1abc54, #25D366); border-color: #25D366; }
    .step.completed .step-number { background: #25D366; border-color: #25D366; }
    .step-label { font-size: 0.7rem; opacity: 0.7; text-align: center; }
    .step.active .step-label { opacity: 1; color: #25D366; }
    .form-card { background: rgba(255,255,255,0.05); border-radius: 25px; padding: 35px 25px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
    .wave-badge { background: linear-gradient(135deg, #1abc54, #25D366); border-radius: 15px; padding: 15px 20px; display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 25px; }
    .wave-badge i { font-size: 2rem; }
    .wave-badge span { font-weight: 700; font-size: 1.2rem; }
    .form-header { text-align: center; margin-bottom: 25px; }
    .form-header h1 { font-size: 1.6rem; margin-bottom: 8px; }
    .form-header p { opacity: 0.7; font-size: 0.9rem; }
    .alert { padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
    .alert-error { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #ef4444; }
    .alert-success { background: rgba(37,211,102,0.1); border: 1px solid rgba(37,211,102,0.3); color: #25D366; }
    .hidden { display: none !important; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.95rem; }
    .form-group label .required { color: #ff6b6b; }
    .form-control { width: 100%; padding: 14px 18px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; font-size: 1rem; font-family: inherit; transition: all 0.3s; }
    .form-control:focus { outline: none; border-color: #25D366; background: rgba(255,255,255,0.15); }
    .form-control::placeholder { color: rgba(255,255,255,0.5); }
    .plan-options { display: grid; gap: 10px; }
    .plan-option { display: flex; align-items: center; padding: 16px 18px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s; }
    .plan-option:hover { border-color: rgba(37,211,102,0.5); background: rgba(255,255,255,0.08); }
    .plan-option.selected { border-color: #25D366; background: rgba(37,211,102,0.12); }
    .plan-option input { display: none; }
    .plan-icon { font-size: 1.8rem; margin-right: 15px; }
    .plan-info { flex: 1; }
    .plan-name { font-weight: 700; font-size: 1rem; margin-bottom: 3px; }
    .plan-desc { font-size: 0.8rem; opacity: 0.7; }
    .plan-price { text-align: right; }
    .plan-price .amount { font-size: 1.3rem; font-weight: 800; color: #25D366; }
    .plan-price .currency { font-size: 0.75rem; opacity: 0.7; }
    .btn-submit { width: 100%; padding: 16px; background: linear-gradient(135deg, #1abc54, #25D366); border: none; border-radius: 12px; color: white; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; }
    .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(37,211,102,0.3); }
    .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .step-content { display: none; }
    .step-content.active { display: block; }
    .payment-screen { text-align: center; }
    .payment-amount { font-size: 2.8rem; font-weight: 800; color: #25D366; margin: 15px 0; }
    .payment-amount span { font-size: 1rem; opacity: 0.7; }
    .wave-pay-button { display: inline-flex; align-items: center; gap: 12px; padding: 18px 45px; background: linear-gradient(135deg, #1abc54, #25D366); border-radius: 50px; color: white; font-size: 1.2rem; font-weight: 700; text-decoration: none; transition: all 0.3s; margin: 15px 0; }
    .wave-pay-button:hover { transform: scale(1.05); box-shadow: 0 15px 40px rgba(37,211,102,0.4); }
    .wave-pay-button i { font-size: 1.4rem; }
    .ussd-box { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 18px; margin: 20px 0; }
    .ussd-code { font-family: monospace; font-size: 1.3rem; color: #25D366; background: rgba(37,211,102,0.1); padding: 12px 20px; border-radius: 8px; display: inline-block; margin: 10px 0; letter-spacing: 1px; }
    .divider { display: flex; align-items: center; margin: 20px 0; }
    .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.2); }
    .divider span { padding: 0 15px; opacity: 0.7; font-size: 0.85rem; }
    .success-screen { text-align: center; padding: 30px 15px; }
    .success-icon { width: 90px; height: 90px; background: linear-gradient(135deg, #1abc54, #25D366); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; font-size: 2.5rem; }
    .activation-code-box { background: linear-gradient(135deg, rgba(37,211,102,0.15), rgba(37,211,102,0.08)); border: 2px solid #25D366; border-radius: 15px; padding: 25px 20px; margin: 25px 0; }
    .activation-code-box h3 { font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px; font-weight: 500; }
    .activation-code { font-size: 1.5rem; font-weight: 800; font-family: monospace; color: #25D366; letter-spacing: 2px; word-break: break-all; }
    .copy-btn { display: inline-flex; align-items: center; gap: 8px; margin-top: 15px; padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer; transition: all 0.3s; font-size: 0.9rem; }
    .copy-btn:hover { background: rgba(255,255,255,0.2); }
    .whatsapp-box { background: rgba(37,211,102,0.1); border-radius: 12px; padding: 20px; margin-top: 25px; }
    .whatsapp-box h4 { margin-bottom: 12px; font-size: 0.95rem; }
    .whatsapp-command { display: inline-block; background: rgba(37,211,102,0.2); padding: 12px 20px; border-radius: 10px; font-family: monospace; font-size: 1rem; color: #25D366; margin: 10px 0; }
    .confirm-payment-section { background: rgba(37,211,102,0.08); border: 2px solid rgba(37,211,102,0.3); border-radius: 15px; padding: 25px; margin-top: 25px; }
    .confirm-payment-section h3 { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; font-size: 1.1rem; }
    .confirm-payment-section p { font-size: 0.9rem; opacity: 0.8; margin-bottom: 15px; }
    .transaction-input { margin-bottom: 15px; }
    .transaction-input label { display: block; margin-bottom: 8px; font-size: 0.9rem; font-weight: 500; }
    .transaction-input input { width: 100%; padding: 14px 18px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; color: white; font-size: 1rem; font-family: inherit; }
    .transaction-input input:focus { outline: none; border-color: #25D366; }
    .transaction-input small { display: block; margin-top: 8px; font-size: 0.8rem; opacity: 0.7; }
    .loading { display: none; text-align: center; padding: 40px; }
    .loading.active { display: block; }
    .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: #25D366; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .info-box { background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; padding: 15px; margin: 15px 0; }
    .info-box p { font-size: 0.85rem; opacity: 0.9; line-height: 1.5; }
    .info-box i { color: #3b82f6; }
    .timer { font-size: 0.85rem; color: #f59e0b; margin-top: 10px; }
    @media (max-width: 480px) {
      .container { padding: 10px; }
      .form-card { padding: 25px 18px; }
      .plan-option { padding: 14px; }
      .plan-icon { font-size: 1.5rem; margin-right: 12px; }
      .plan-price .amount { font-size: 1.1rem; }
      .payment-amount { font-size: 2.2rem; }
      .wave-pay-button { padding: 15px 30px; font-size: 1rem; }
      .activation-code { font-size: 1.2rem; }
      .step-label { font-size: 0.65rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
    
    <div class="progress-steps">
      <div class="step active" data-step="1">
        <div class="step-number">1</div>
        <span class="step-label">Inscription</span>
      </div>
      <div class="step" data-step="2">
        <div class="step-number">2</div>
        <span class="step-label">Payer Wave</span>
      </div>
      <div class="step" data-step="3">
        <div class="step-number">3</div>
        <span class="step-label">Confirmer</span>
      </div>
      <div class="step" data-step="4">
        <div class="step-number">4</div>
        <span class="step-label">Code</span>
      </div>
    </div>
    
    <!-- Step 1: Inscription -->
    <div class="step-content active" id="step1">
      <div class="form-card">
        <div class="wave-badge">
          <i class="fas fa-mobile-alt"></i>
          <span>Paiement Wave uniquement</span>
        </div>
        
        <div class="form-header">
          <h1>üíé S'abonner √† HANI-MD</h1>
          <p>Payez avec Wave et recevez votre code instantan√©ment</p>
        </div>
        
        <div id="errorAlert" class="alert alert-error hidden">
          <i class="fas fa-exclamation-circle"></i>
          <span id="errorMessage"></span>
        </div>
        
        <form id="subscribeForm">
          <div class="form-group">
            <label>Votre nom complet <span class="required">*</span></label>
            <input type="text" class="form-control" id="userName" placeholder="Ex: Jean Kouassi" required minlength="3">
          </div>
          
          <div class="form-group">
            <label>Num√©ro WhatsApp <span class="required">*</span></label>
            <input type="tel" class="form-control" id="userPhone" placeholder="Ex: 0150252467" required minlength="8">
            <small style="opacity: 0.6; margin-top: 5px; display: block; font-size: 0.8rem;">
              <i class="fas fa-info-circle"></i> Num√©ro sur lequel vous utiliserez le bot
            </small>
          </div>
          
          <div class="form-group">
            <label>Choisissez votre plan <span class="required">*</span></label>
            <div class="plan-options" id="planOptions">
              <label class="plan-option" data-plan="BRONZE" data-price="500">
                <input type="radio" name="plan" value="BRONZE">
                <span class="plan-icon">ü•â</span>
                <div class="plan-info">
                  <div class="plan-name">Bronze</div>
                  <div class="plan-desc">100 cmd/jour ‚Ä¢ 30 jours</div>
                </div>
                <div class="plan-price"><div class="amount">500</div><div class="currency">FCFA</div></div>
              </label>
              
              <label class="plan-option" data-plan="ARGENT" data-price="1000">
                <input type="radio" name="plan" value="ARGENT">
                <span class="plan-icon">ü•à</span>
                <div class="plan-info">
                  <div class="plan-name">Argent</div>
                  <div class="plan-desc">300 cmd/jour ‚Ä¢ 30 jours</div>
                </div>
                <div class="plan-price"><div class="amount">1 000</div><div class="currency">FCFA</div></div>
              </label>
              
              <label class="plan-option selected" data-plan="OR" data-price="2000">
                <input type="radio" name="plan" value="OR" checked>
                <span class="plan-icon">ü•á</span>
                <div class="plan-info">
                  <div class="plan-name">Or ‚≠ê Populaire</div>
                  <div class="plan-desc">Illimit√© ‚Ä¢ 30 jours</div>
                </div>
                <div class="plan-price"><div class="amount">2 000</div><div class="currency">FCFA</div></div>
              </label>
              
              <label class="plan-option" data-plan="DIAMANT" data-price="5000">
                <input type="radio" name="plan" value="DIAMANT">
                <span class="plan-icon">üíé</span>
                <div class="plan-info">
                  <div class="plan-name">Diamant</div>
                  <div class="plan-desc">Tout illimit√© ‚Ä¢ 30 jours</div>
                </div>
                <div class="plan-price"><div class="amount">5 000</div><div class="currency">FCFA</div></div>
              </label>
              
              <label class="plan-option" data-plan="LIFETIME" data-price="15000">
                <input type="radio" name="plan" value="LIFETIME">
                <span class="plan-icon">üëë</span>
                <div class="plan-info">
                  <div class="plan-name">Lifetime</div>
                  <div class="plan-desc">Acc√®s √† vie</div>
                </div>
                <div class="plan-price"><div class="amount">15 000</div><div class="currency">FCFA</div></div>
              </label>
            </div>
          </div>
          
          <button type="submit" class="btn-submit">
            <i class="fas fa-arrow-right"></i> Continuer vers Wave
          </button>
        </form>
      </div>
    </div>
    
    <!-- Step 2: Paiement Wave -->
    <div class="step-content" id="step2">
      <div class="form-card">
        <div class="payment-screen">
          <h2>üí≥ Payez avec Wave</h2>
          <p style="opacity: 0.8; margin-top: 5px;">Cliquez sur le bouton pour ouvrir Wave</p>
          
          <div class="payment-amount">
            <span id="paymentAmount">2 000</span> <span>FCFA</span>
          </div>
          
          <div style="opacity: 0.8; margin-bottom: 15px;">
            <p><strong id="displayName"></strong></p>
            <p>Plan: <strong id="displayPlan"></strong></p>
            <p style="font-size: 0.85rem; margin-top: 8px;">R√©f: <span id="displayRef" style="color: #25D366; font-family: monospace;"></span></p>
          </div>
          
          <button type="button" id="wavePayButton" class="wave-pay-button" onclick="copyUSSD();">
            <i class="fas fa-copy"></i> Copier le code USSD
          </button>
          
          <div class="divider"><span>ou code USSD</span></div>
          
          <div class="ussd-box">
            <p style="margin-bottom: 8px; font-size: 0.9rem;">Composez ce code sur votre t√©l√©phone :</p>
            <div class="ussd-code" id="ussdCode">Compte: CI 58 32 12 09</div>
          </div>
          
          <div class="info-box">
            <p><i class="fas fa-info-circle"></i> Apr√®s le paiement Wave, notez le <strong>num√©ro de transaction</strong> qui s'affiche dans Wave (ex: TXN123456)</p>
          </div>
          
          <button type="button" id="goToConfirmBtn" class="btn-submit" style="margin-top: 20px;">
            <i class="fas fa-check"></i> J'ai pay√©, confirmer mon paiement
          </button>
        </div>
      </div>
    </div>
    
    <!-- Step 3: Confirmation du paiement -->
    <div class="step-content" id="step3">
      <div class="form-card">
        <div class="form-header">
          <h1>‚úÖ Confirmer votre paiement</h1>
          <p>Entrez les d√©tails de votre transaction Wave</p>
        </div>
        
        <div id="confirmError" class="alert alert-error hidden">
          <i class="fas fa-exclamation-circle"></i>
          <span id="confirmErrorMessage"></span>
        </div>
        
        <div class="transaction-input">
          <label>N¬∞ de transaction Wave <span class="required">*</span></label>
          <input type="text" class="form-control" id="transactionId" placeholder="Ex: TXN123456789 ou ID affich√© dans Wave">
          <small><i class="fas fa-info-circle"></i> Vous le trouvez dans Wave apr√®s le paiement, dans l'historique ou le re√ßu</small>
        </div>
        
        <div class="transaction-input">
          <label>Num√©ro Wave utilis√© pour payer <span class="required">*</span></label>
          <input type="tel" class="form-control" id="waveNumber" placeholder="Ex: 0778901234">
          <small><i class="fas fa-info-circle"></i> Le num√©ro depuis lequel vous avez envoy√© l'argent</small>
        </div>
        
        <div class="info-box">
          <p><i class="fas fa-shield-alt"></i> <strong>S√©curit√©:</strong> Ces informations nous permettent de v√©rifier votre paiement. Votre code sera g√©n√©r√© instantan√©ment apr√®s confirmation.</p>
        </div>
        
        <button type="button" id="confirmPaymentBtn" class="btn-submit">
          <i class="fas fa-check-circle"></i> Confirmer et recevoir mon code
        </button>
        
        <p style="text-align: center; margin-top: 15px; font-size: 0.85rem; opacity: 0.7;">
          <a href="#" id="backToPayBtn" style="color: #25D366;">‚Üê Retour au paiement</a>
        </p>
      </div>
    </div>
    
    <!-- Step 4: Code d'activation -->
    <div class="step-content" id="step4">
      <div class="form-card">
        <div class="success-screen">
          <div class="success-icon"><i class="fas fa-check"></i></div>
          <h2>üéâ Paiement confirm√© !</h2>
          <p style="opacity: 0.8;">Voici votre code d'activation</p>
          
          <div class="activation-code-box">
            <h3>Votre code d'activation</h3>
            <div class="activation-code" id="activationCode">HANI-OR-XXXXXXXX</div>
            <button type="button" class="copy-btn" id="copyCodeBtn">
              <i class="fas fa-copy"></i> Copier le code
            </button>
          </div>
          
          <div class="whatsapp-box">
            <h4>üì± Comment activer sur WhatsApp :</h4>
            <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px;">Envoyez cette commande au bot :</p>
            <div class="whatsapp-command" id="whatsappCommand">.activer HANI-OR-XXXXXXXX</div>
          </div>
          
          <a href="https://wa.me/225150252467" class="wave-pay-button" style="background: #25D366; margin-top: 25px;" target="_blank">
            <i class="fab fa-whatsapp"></i> Ouvrir WhatsApp
          </a>
          
          <div class="info-box" style="margin-top: 20px;">
            <p><i class="fas fa-save"></i> <strong>Important:</strong> Conservez ce code ! Vous pouvez aussi le retrouver dans votre historique.</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Loading -->
    <div class="loading" id="loadingScreen">
      <div class="spinner"></div>
      <p id="loadingText">Traitement en cours...</p>
    </div>
  </div>
  
  <script>
    let currentStep = 1;
    let subscriberData = null;
    const MERCHANT_NUMBER = 'CI58321209'; // Compte Marchand Wave Business
    const MERCHANT_DISPLAY = 'CI 58 32 12 09'; // Format affichage
    const MERCHANT_NAME = 'Boutique H';
    const WHATSAPP_INTL = '225150252467'; // Format international
    
    const planOptions = document.querySelectorAll('.plan-option');
    const form = document.getElementById('subscribeForm');
    
    // S√©lection plan
    planOptions.forEach(opt => {
      opt.addEventListener('click', () => {
        planOptions.forEach(o => o.classList.remove('selected'));
        opt.classList.add('selected');
        opt.querySelector('input').checked = true;
      });
    });
    
    // √âtape 1: Soumission formulaire d'inscription
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('userName').value.trim();
      const phone = document.getElementById('userPhone').value.trim();
      const plan = document.querySelector('input[name="plan"]:checked').value;
      
      if (!name || name.length < 3) { showError('Entrez votre nom complet'); return; }
      if (!phone || phone.length < 8) { showError('Num√©ro WhatsApp invalide'); return; }
      
      showLoading(true, 'Cr√©ation de votre demande...');
      hideError();
      
      try {
        const res = await fetch('/api/wave/subscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, phone, plan })
        });
        const data = await res.json();
        
        if (data.success) {
          subscriberData = data;
          localStorage.setItem('currentSubscription', JSON.stringify(data));
          updatePaymentScreen(data);
          goToStep(2);
        } else {
          showError(data.error || 'Erreur lors de l\'inscription');
        }
      } catch (err) {
        showError('Erreur de connexion au serveur');
      }
      showLoading(false);
    });
    
    // √âtape 2: Aller √† la confirmation
    document.getElementById('goToConfirmBtn').addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      goToStep(3);
    });
    
    // Retour au paiement
    document.getElementById('backToPayBtn').addEventListener('click', (e) => {
      e.preventDefault();
      goToStep(2);
    });
    
    // √âtape 3: Confirmer le paiement
    document.getElementById('confirmPaymentBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      const transactionId = document.getElementById('transactionId').value.trim();
      const waveNumber = document.getElementById('waveNumber').value.trim();
      
      if (!transactionId) {
        showConfirmError('Entrez le num√©ro de transaction Wave');
        return;
      }
      if (!waveNumber || waveNumber.length < 8) {
        showConfirmError('Entrez un num√©ro Wave valide');
        return;
      }
      
      hideConfirmError();
      showLoading(true, 'V√©rification et g√©n√©ration de votre code...');
      
      try {
        const res = await fetch('/api/wave/confirm-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subscriberId: subscriberData?.subscriber?.id,
            transactionId: transactionId,
            waveNumber: waveNumber,
            paymentRef: subscriberData?.subscriber?.paymentRef
          })
        });
        const data = await res.json();
        
        if (data.success && data.activationCode) {
          localStorage.removeItem('currentSubscription');
          showSuccessScreen(data.activationCode);
          goToStep(4);
        } else {
          showConfirmError(data.error || 'Erreur lors de la confirmation');
        }
      } catch (err) {
        showConfirmError('Erreur de connexion. Veuillez r√©essayer.');
      }
      showLoading(false);
    });
    
    // Copier code
    document.getElementById('copyCodeBtn').addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const code = document.getElementById('activationCode').textContent;
      navigator.clipboard.writeText(code).then(() => {
        const btn = document.getElementById('copyCodeBtn');
        btn.innerHTML = '<i class="fas fa-check"></i> Copi√© !';
        setTimeout(() => { btn.innerHTML = '<i class="fas fa-copy"></i> Copier le code'; }, 2000);
      });
    });
    
    // V√©rifier s'il y a une souscription en cours au chargement
    window.addEventListener('load', () => {
      const saved = localStorage.getItem('currentSubscription');
      if (saved) {
        try {
          subscriberData = JSON.parse(saved);
          if (subscriberData?.subscriber) {
            updatePaymentScreen(subscriberData);
            goToStep(2);
          }
        } catch (e) {
          localStorage.removeItem('currentSubscription');
        }
      }
    });
    
    function goToStep(step) {
      currentStep = step;
      document.querySelectorAll('.step').forEach((s, i) => {
        s.classList.remove('active', 'completed');
        if (i + 1 < step) s.classList.add('completed');
        if (i + 1 === step) s.classList.add('active');
      });
      document.querySelectorAll('.step-content').forEach((c, i) => {
        c.classList.toggle('active', i + 1 === step);
      });
    }
    
    function updatePaymentScreen(data) {
      const planNames = { BRONZE: 'ü•â Bronze', ARGENT: 'ü•à Argent', OR: 'ü•á Or', DIAMANT: 'üíé Diamant', LIFETIME: 'üëë Lifetime' };
      const amount = data.subscriber?.amount || 2000;
      const plan = data.subscriber?.plan || 'OR';
      const paymentRef = data.subscriber?.paymentRef || 'N/A';
      
      document.getElementById('paymentAmount').textContent = amount.toLocaleString('fr-FR');
      document.getElementById('displayName').textContent = data.subscriber?.name || '';
      document.getElementById('displayPlan').textContent = planNames[plan] || plan;
      document.getElementById('displayRef').textContent = paymentRef;
      document.getElementById('ussdCode').textContent = `Compte: CI 58 32 12 09 - ${amount} FCFA`;
    }
    
    function showSuccessScreen(code) {
      document.getElementById('activationCode').textContent = code;
      document.getElementById('whatsappCommand').textContent = `.activer ${code}`;
    }
    
    function showLoading(show, text = 'Traitement en cours...') {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingScreen').style.display = show ? 'block' : 'none';
    }
    
    function showError(msg) {
      document.getElementById('errorMessage').textContent = msg;
      document.getElementById('errorAlert').classList.remove('hidden');
    }
    
    function hideError() {
      document.getElementById('errorAlert').classList.add('hidden');
    }
    
    function showConfirmError(msg) {
      document.getElementById('confirmErrorMessage').textContent = msg;
      document.getElementById('confirmError').classList.remove('hidden');
    }
    
    function hideConfirmError() {
      document.getElementById('confirmError').classList.add('hidden');
    }
    
    function copyUSSD() {
      navigator.clipboard.writeText('CI58321209').then(() => {
        const btn = document.getElementById('wavePayButton');
        btn.innerHTML = '<i class="fas fa-check"></i> Num√©ro copi√© !';
        setTimeout(() => {
          btn.innerHTML = '<i class="fas fa-copy"></i> Copier le num√©ro marchand';
        }, 2000);
      });
    }
  </script>
</body>
</html>
